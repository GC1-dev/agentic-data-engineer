environment_type: test_integration

spark:
  app_name: "test_integration_transformations"
  master: local[2]  # 2 threads for complex transformations
  config:
    # Session timezone
    spark.sql.session.timeZone: "UTC"
    
    # Memory Configuration (increased for integration tests)
    # Driver memory: Memory allocated to the Spark driver process
    spark.driver.memory: "4g"  # Increased from default 1g
    # Executor memory: Memory for executor processes (for local mode, driver handles this)
    spark.executor.memory: "4g"
    # Overhead memory: Additional memory for off-heap allocations
    spark.driver.memoryOverhead: "1g"
    spark.executor.memoryOverhead: "1g"
    # Maximum result size: Limit data returned to driver
    spark.driver.maxResultSize: "2g"

    # Performance Tuning (moderate resources)
    spark.sql.shuffle.partitions: "2"
    spark.default.parallelism: "2"

    # Storage
    spark.sql.warehouse.dir: "spark-warehouse-integration"

    # Delta Lake Support (required for Delta operations)
    spark.sql.extensions: "io.delta.sql.DeltaSparkSessionExtension"
    spark.sql.catalog.spark_catalog: "org.apache.spark.sql.delta.catalog.DeltaCatalog"

    # Optimization (enable realistic production-like behavior)
    spark.sql.adaptive.enabled: "true"  # Enable AQE like production
    spark.databricks.delta.optimizeWrite.enabled: "true"
    spark.databricks.delta.retentionDurationCheck.enabled: "false"
    spark.databricks.delta.schema.autoMerge.enabled: "true"
    spark.databricks.delta.optimize.zorder.checkStatsCollection.enabled: "false"

    # Memory Management
    # Storage memory fraction: Reduce to allow more execution memory
    spark.memory.storageFraction: "0.3"  # Default: 0.5, lower = more execution memory
    # Off-heap memory: Enable to reduce heap pressure
    spark.memory.offHeap.enabled: "true"
    spark.memory.offHeap.size: "1g"
    # Broadcast timeout: Increase for large broadcasts
    spark.sql.broadcastTimeout: "600"

# Database/Catalog Configuration
data_catalog:
  catalog: "test_catalog"
  schema: "test_schema"

logging:
  level: "info"
