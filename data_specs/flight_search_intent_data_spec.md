# Data Product Specification: Flight Search Intent

## Overview

### Data Product Information
- **Name**: Flight Search Intent
- **Domain**: Meta Business Domain - Search
- **Version**: 1.0.0
- **Status**: Active
- **Owner**: Meta Business Domain Team
- **Last Updated**: 2025-10-26

### Description
The Flight Search Intent entity captures a traveler's intent to search for flights by recording the action when they enter their travel criteria (origin, destination, travel dates, number of passengers, cabin class) into a flight search platform and submit it to find available flights. This request is sent to backend systems, which then query airline and partner inventories to find matching flight options. Each request is uniquely identified and contains all the parameters needed to perform the search.

A traveler may generate multiple search events as they narrow down their options, for example when progressing from an "Everywhere" search, to a "browse" search, to a search where all locations and dates are specified.

### Key Business Use Cases
- Track user search behavior and intent
- Analyze search patterns (defined vs exploratory searches)
- Monitor platform usage (Android, iOS, Web)
- Support personalization and recommendations
- Enable search funnel analysis
- Measure conversion from search to booking

---

## Data Contract

### Destination Table
- **Database**: `dev_trusted_lab.meta_business_domain_silver`
- **Table**: `flight_search_intent`
- **Full Name**: `dev_trusted_lab.meta_business_domain_silver.flight_search_intent`
- **Format**: Delta Table
- **Layer**: Silver (Curated)

### Service Level Agreement (SLA)
- **Refresh Frequency**: Daily
- **Availability**: 99.9%
- **Data Latency**: T+1 (Next day after event occurs)
- **Data Quality**: High - All data quality checks must pass

---

## Data Sources

### Input Sources (Bronze Layer)

#### Primary Event Sources
1. **android_mini_search**
   - **Full Name**: `prod_trusted_bronze.internal.android_mini_search`
   - **Type**: Event Stream
   - **Platform**: Android App
   - **Description**: Search events from Android mobile application

2. **ios_mini_search**
   - **Full Name**: `prod_trusted_bronze.internal.ios_mini_search`
   - **Type**: Event Stream
   - **Platform**: iOS App
   - **Description**: Search events from iOS mobile application

3. **frontend_mini_search**
   - **Full Name**: `prod_trusted_bronze.internal.frontend_mini_search`
   - **Type**: Event Stream
   - **Platform**: Website
   - **Description**: Search events from frontend web application

4. **banana_mini_search**
   - **Full Name**: `prod_trusted_bronze.internal.banana_mini_search`
   - **Type**: Event Stream
   - **Platform**: Website
   - **Description**: Search events from Banana web platform

5. **acorn_funnel_events_search**
   - **Full Name**: `prod_trusted_bronze.internal.acorn_funnel_events_search`
   - **Type**: Event Stream
   - **Platform**: Website
   - **Description**: Search funnel events from Acorn web platform

6. **server_mini_search** (LEGACY - Historical Use Only)
   - **Full Name**: `prod_trusted_bronze.internal.server_mini_search`
   - **Type**: Event Stream
   - **Platform**: Website
   - **Description**: Legacy server-side search events (SOL web)

### Reference Data Sources (Silver Layer)

1. **geography**
   - **Full Name**: `prod_trusted_silver.reference.geography`
   - **Type**: Reference Dimension
   - **Description**: Geographic entity reference data for mapping location IDs to standardized entity information
   - **Join Key**: `entity_id`, `sky_code`
   - **Usage**: Map origin and destination location IDs to standardized geographic entities

2. **user_agent**
   - **Full Name**: `prod_trusted_silver.reference.user_agent`
   - **Type**: Reference Dimension
   - **Description**: User agent string reference data
   - **Join Key**: `user_agent`
   - **Usage**: Enrich user agent information

3. **currency_conversion**
   - **Full Name**: `prod_trusted_silver.reference.currency_conversion`
   - **Type**: Reference Dimension
   - **Description**: Currency conversion rates
   - **Usage**: Future use for currency normalization

---

## Schema Definition

### Primary Key
- **Column**: `search_request_id`
- **Type**: STRING
- **Generation**: `xxhash64(request_id, guid, utid, dt)`
- **Description**: Unique identifier for each search request, generated by hashing the combination of request_id, guid, utid, and date partition

### Natural Key
- **Columns**: `request_id + guid + utid + dt`
- **Description**: Business key combination that uniquely identifies a search request

### Foreign Key Relationships

| Column | References | Description |
|--------|------------|-------------|
| `utid` | `dev_trusted_lab.other_business_domain_silver_meta_related_pbm.user.utid` | User tracking identifier |
| `view_id` | `dev_trusted_lab.other_business_domain_silver_meta_related_pbm.view.view_id` | Page view identifier |
| `user_agent` | `dev_trusted_lab.other_business_domain_silver_meta_related_pbm.user_agent.user_agent` | User agent reference |
| `origin_entity_id` | `dev_trusted_lab.other_business_domain_silver_meta_related_pbm.geography.entity_id` | Origin location reference |
| `destination_entity_id` | `dev_trusted_lab.other_business_domain_silver_meta_related_pbm.geography.entity_id` | Destination location reference |

---

## Column Specifications

### Identifiers

#### search_request_id
- **Type**: STRING
- **Nullable**: False
- **Primary Key**: Yes
- **Source**: Derived
- **Business Logic**: Generate a unique identifier by computing the xxhash64 hash of the concatenation of request_id, guid, utid, and dt
- **Purpose**: Unique entity identifier for deduplication and primary key

#### request_id
- **Type**: STRING
- **Nullable**: True
- **Source**: Direct mapping from source tables
- **Source Column**: `request_id`
- **Business Logic**: Extract request_id directly from the source event. Clean the string by removing leading/trailing whitespace and converting empty strings to NULL
- **Purpose**: Request ID linking related events (e.g., redirects) to the initial search

#### previous_event_id
- **Type**: STRING
- **Nullable**: True
- **Source**: Direct mapping
- **Source Column**: `previous_event_id`
- **Business Logic**: Extract previous_event_id directly from the source event
- **Purpose**: Links to the previous event in the user journey

#### view_id
- **Type**: STRING
- **Nullable**: True
- **Source**: Direct mapping
- **Source Column**: `view_id`
- **Business Logic**: Extract view_id directly from the source event. Clean the string by removing leading/trailing whitespace and converting empty strings to NULL
- **Purpose**: Unique page view identifier - links to the View entity for page-level context

### User Identification

#### utid
- **Type**: STRING
- **Nullable**: True
- **Source**: Direct mapping
- **Source Column**: `utid`
- **Business Logic**: Extract utid (user tracking identifier) directly from the source event. Clean the string by removing leading/trailing whitespace and converting empty strings to NULL
- **Purpose**: User tracking identifier for cross-session user analysis

#### guid
- **Type**: STRING
- **Nullable**: True
- **Source**: Direct mapping
- **Source Column**: `guid`
- **Business Logic**: Extract guid (globally unique identifier) directly from the source event. Clean the string by removing leading/trailing whitespace and converting empty strings to NULL
- **Purpose**: Global user identifier

#### device_guid
- **Type**: STRING
- **Nullable**: True
- **Source**: Direct mapping
- **Source Column**: `header.device_guid`
- **Business Logic**: Extract device GUID from the event header
- **Purpose**: Device-level tracking identifier

#### authentication_status
- **Type**: STRING
- **Nullable**: True
- **Source**: Direct mapping
- **Source Column**: `header.traveller_identity.authentication_status`
- **Business Logic**: Extract authentication status from traveller identity in header
- **Purpose**: Indicates whether the user is logged in or anonymous

### Timestamps

#### logged_event_utc_timestamp
- **Type**: TIMESTAMP
- **Nullable**: True
- **Source**: Derived from `grappler_receive_timestamp.unix_time_millis`
- **Business Logic**: Extract the Unix timestamp in milliseconds from grappler_receive_timestamp and convert it to a proper timestamp data type by dividing by 1000 and casting to timestamp
- **Purpose**: Server-side timestamp when the event was received (UTC)

#### client_timestamp
- **Type**: TIMESTAMP
- **Nullable**: True
- **Source**: Derived from `header.client_timestamp.unix_time_millis`
- **Business Logic**: Extract the Unix timestamp in milliseconds from header.client_timestamp and convert it to a proper timestamp data type by dividing by 1000 and casting to timestamp
- **Purpose**: Client-side timestamp when the event was generated

#### md_last_modified_utc_timestamp
- **Type**: TIMESTAMP
- **Nullable**: False
- **Source**: System generated
- **Business Logic**: Set to current UTC timestamp whenever the record is created or updated
- **Purpose**: Metadata timestamp for record modification tracking

### Trip Date Attributes

#### departure_timestamp
- **Type**: TIMESTAMP
- **Nullable**: True
- **Source**: Derived from `start_date.unix_time_millis`
- **Business Logic**: Extract the departure Unix timestamp in milliseconds from start_date and convert it to a proper timestamp. Where there is no time specified (i.e., for flight or hotel searches), the time defaults to 00:00. For month searches, the start_datetime is the first day of the month. For anytime searches, the start_datetime is 2999-12-31 00:00:00
- **Purpose**: Departure date and time as specified by the traveler

#### departure_timestamp_precision
- **Type**: STRING
- **Nullable**: True
- **Source**: Derived from `start_date.date_time_kind`
- **Business Logic**: Extract the date_time_kind from start_date and normalize it to standard precision values (DAY, MONTH, ANYTIME, MINUTE). This indicates the precision or granularity of the departure date specified by the user
- **Purpose**: Indicates the granularity of the departure date (helps identify unfocused searches)

#### departure_date
- **Type**: DATE
- **Nullable**: True
- **Source**: Derived from `departure_timestamp`
- **Business Logic**: Extract only the date portion from departure_timestamp by casting it to a date type
- **Purpose**: Departure date without time component for simplified date-based analysis

#### arrival_timestamp
- **Type**: TIMESTAMP
- **Nullable**: True
- **Source**: Derived from `end_date.unix_time_millis`
- **Business Logic**: Extract the arrival Unix timestamp in milliseconds from end_date and convert it to a proper timestamp. Where there is no time specified, the time defaults to 00:00
- **Purpose**: Arrival/return date and time as specified by the traveler

#### arrival_timestamp_precision
- **Type**: STRING
- **Nullable**: True
- **Source**: Derived from `end_date.date_time_kind`
- **Business Logic**: Extract the date_time_kind from end_date and normalize it to standard precision values (DAY, MONTH, ANYTIME, MINUTE). This indicates the precision or granularity of the arrival date specified by the user
- **Purpose**: Indicates the granularity of the arrival date

#### arrival_date
- **Type**: DATE
- **Nullable**: True
- **Source**: Derived from `arrival_timestamp`
- **Business Logic**: Extract only the date portion from arrival_timestamp by casting it to a date type
- **Purpose**: Arrival date without time component for simplified date-based analysis

#### trip_duration_days
- **Type**: INTEGER
- **Nullable**: True
- **Source**: Calculated
- **Business Logic**: Calculate the number of days between departure_date and arrival_date using the datediff function. This represents the length of stay or trip duration in whole days
- **Purpose**: Number of trip days for trip length analysis

### Trip Attributes

#### cabin_class
- **Type**: STRING
- **Nullable**: True
- **Source**: Conditional extraction from `flight_search.cabin_class` or `combined_search.flight_search.cabin_class`
- **Business Logic**: If flight_search.cabin_class is not null, use flight_search.cabin_class; otherwise use combined_search.flight_search.cabin_class. This handles both standalone flight searches and combined searches
- **Purpose**: Class of fare selected (e.g., economy, premium, business)

#### search_kind
- **Type**: STRING
- **Nullable**: True
- **Source**: Conditional extraction from `flight_search.search_kind` or `combined_search.flight_search.search_kind`
- **Business Logic**: If flight_search.search_kind is not null, use flight_search.search_kind; otherwise use combined_search.flight_search.search_kind
- **Purpose**: Type/kind of search performed

#### trip_type
- **Type**: STRING
- **Nullable**: True
- **Source**: Derived from trip structure fields
- **Business Logic**: Determine trip type by checking which trip structure is populated: If flight_search.one_way or combined_search.flight_search.one_way is not null, set to "ONE_WAY". If flight_search.return or combined_search.flight_search.return is not null, set to "RETURN". If flight_search.multi_city or combined_search.flight_search.multi_city is not null, set to "MULTI_CITY"
- **Purpose**: Type of trip: ONE_WAY, RETURN, or MULTI_CITY

#### number_of_legs
- **Type**: INTEGER
- **Nullable**: True
- **Source**: Derived from trip_type
- **Business Logic**: Calculate the number of legs based on trip_type: If trip_type is "ONE_WAY", set to 1. If trip_type is "RETURN", set to 2. If trip_type is "MULTI_CITY", count the number of legs in the multi_city structure (size of flight_search.multi_city.legs array for FLIGHT vertical, or size of combined_search.flight_search.multi_city.legs array for COMBINED_SEARCH vertical). Otherwise, set to 0
- **Purpose**: Total number of flight legs in the trip

### Traveler Choices / Filters

#### is_cabin_bag_required
- **Type**: BOOLEAN
- **Nullable**: True
- **Source**: Conditional extraction from `flight_search.is_cabin_bag_required` or `combined_search.flight_search.is_cabin_bag_required`
- **Business Logic**: If flight_search.is_cabin_bag_required is not null, use flight_search.is_cabin_bag_required; otherwise use combined_search.flight_search.is_cabin_bag_required
- **Purpose**: Flag indicating if cabin baggage is required by the traveler

#### is_checked_bag_required
- **Type**: BOOLEAN
- **Nullable**: True
- **Source**: Conditional extraction from `flight_search.is_checked_bag_required` or `combined_search.flight_search.is_checked_bag_required`
- **Business Logic**: If flight_search.is_checked_bag_required is not null, use flight_search.is_checked_bag_required; otherwise use combined_search.flight_search.is_checked_bag_required
- **Purpose**: Flag indicating if checked baggage is required by the traveler

#### is_origin_nearby_airport_selected
- **Type**: BOOLEAN
- **Nullable**: True
- **Source**: Conditional extraction from `flight_search.is_origin_nearby_airport_selected` or `combined_search.flight_search.is_origin_nearby_airport_selected`
- **Business Logic**: If flight_search.is_origin_nearby_airport_selected is not null, use flight_search.is_origin_nearby_airport_selected; otherwise use combined_search.flight_search.is_origin_nearby_airport_selected
- **Purpose**: Flag indicating if nearby airports to the origin are included in the search

#### is_destination_nearby_airport_selected
- **Type**: BOOLEAN
- **Nullable**: True
- **Source**: Conditional extraction from `flight_search.is_destination_nearby_airport_selected` or `combined_search.flight_search.is_destination_nearby_airport_selected`
- **Business Logic**: If flight_search.is_destination_nearby_airport_selected is not null, use flight_search.is_destination_nearby_airport_selected; otherwise use combined_search.flight_search.is_destination_nearby_airport_selected
- **Purpose**: Flag indicating if nearby airports to the destination are included in the search

#### is_direct_only_selected
- **Type**: BOOLEAN
- **Nullable**: True
- **Source**: Conditional extraction from `flight_search.is_direct_only_selected` or `combined_search.flight_search.is_direct_only_selected`
- **Business Logic**: If flight_search.is_direct_only_selected is not null, use flight_search.is_direct_only_selected; otherwise use combined_search.flight_search.is_direct_only_selected
- **Purpose**: Flag indicating if only direct (non-stop) flights are requested

### Passenger Information

#### passenger_group_model
- **Type**: STRING
- **Nullable**: True
- **Source**: Derived from `passenger_group.group_model`
- **Business Logic**: Extract the passenger_group structure from flight_search.passenger_group or combined_search.flight_search.passenger_group (whichever is not null), then extract the group_model field
- **Purpose**: Model/type of passenger grouping

#### adult_passenger_count
- **Type**: INTEGER
- **Nullable**: True
- **Source**: Derived from `passenger_group.adult_count`
- **Business Logic**: Extract the passenger_group structure from flight_search.passenger_group or combined_search.flight_search.passenger_group (whichever is not null), then extract the adult_count field. Adults are defined as passengers age 18+ as of 2025-09-16 to align with Skyscanner Global Definition
- **Purpose**: Number of adult passengers (age 18+)

#### child_passenger_count
- **Type**: INTEGER
- **Nullable**: True
- **Source**: Derived from `passenger_group.child_count`
- **Business Logic**: Extract the passenger_group structure from flight_search.passenger_group or combined_search.flight_search.passenger_group (whichever is not null), then extract the child_count field. Children are defined as passengers age 2-17 inclusive
- **Purpose**: Number of child passengers (age 2-17)

#### infant_passenger_count
- **Type**: INTEGER
- **Nullable**: True
- **Source**: Derived from `passenger_group.infant_count`
- **Business Logic**: Extract the passenger_group structure from flight_search.passenger_group or combined_search.flight_search.passenger_group (whichever is not null), then extract the infant_count field. Infants are defined as passengers under age 2
- **Purpose**: Number of infant passengers (under age 2)

### Trip Structure Objects

#### one_way_trip
- **Type**: STRUCT containing leg information
- **Nullable**: True
- **Source**: Conditional extraction from `flight_search.one_way` or `combined_search.flight_search.one_way`
- **Business Logic**: If flight_search.one_way is not null, use flight_search.one_way; otherwise use combined_search.flight_search.one_way. This nested structure contains origin, destination, date, and is_cheapest_month for one-way trips
- **Purpose**: One-way trip details including leg information

#### return_trip
- **Type**: STRUCT containing leg1 and leg2 information
- **Nullable**: True
- **Source**: Conditional extraction from `flight_search.return` or `combined_search.flight_search.return`
- **Business Logic**: If flight_search.return is not null, use flight_search.return; otherwise use combined_search.flight_search.return. This nested structure contains leg1 (outbound) and leg2 (return) with origin, destination, date, and is_cheapest_month for each leg
- **Purpose**: Return trip details including both legs

#### multi_city_trip
- **Type**: STRUCT containing array of legs
- **Nullable**: True
- **Source**: Conditional extraction from `flight_search.multi_city` or `combined_search.flight_search.multi_city`
- **Business Logic**: If flight_search.multi_city is not null, use flight_search.multi_city; otherwise use combined_search.flight_search.multi_city. This nested structure contains an array of legs, each with origin, destination, date, and is_cheapest_month
- **Purpose**: Multi-city trip details with multiple legs

### Origin Location Attributes

#### origin_entity_id
- **Type**: STRING
- **Nullable**: True
- **Source**: Derived via geography reference lookup
- **Business Logic**: Extract origin.location_attribute.location_id and location_attribute_encoding. Perform a lookup against the geography reference table: If encoding is "IATA" OR (encoding is "SS_GEO1_ID" or "DDB_ID" and ID length is 2-5), join on geography.sky_code. If encoding is "SS_GEO1_ID" or "DDB_ID" and ID length is 1, 8, or 9, join on geography.entity_id. If the location_id is "1", "EVERYWHERE", "ANYWHERE", or "UNDEFINED", set entity_id to "1". Use the resulting geography.entity_id value
- **Purpose**: Standardized origin entity ID joinable to reference.geography table

#### origin_location_type
- **Type**: STRING
- **Nullable**: True
- **Source**: Derived via geography reference lookup
- **Business Logic**: After performing the geography lookup as described for origin_entity_id, use the geography.entity_type value. If the location is "EVERYWHERE", set to "EVERYWHERE"
- **Purpose**: Type of origin location (e.g., CITY, AIRPORT, ISLAND, EVERYWHERE)

#### origin_location_name
- **Type**: STRING
- **Nullable**: True
- **Source**: Derived via geography reference lookup
- **Business Logic**: After performing the geography lookup as described for origin_entity_id, use the geography.entity_reporting_name value. If the location is "EVERYWHERE", set to "EVERYWHERE"
- **Purpose**: Human-readable name of the origin location

### Destination Location Attributes

#### destination_entity_id
- **Type**: STRING
- **Nullable**: True
- **Source**: Derived via geography reference lookup
- **Business Logic**: Extract destination.location_attribute.location_id and location_attribute_encoding. Perform a lookup against the geography reference table: If encoding is "IATA" OR (encoding is "SS_GEO1_ID" or "DDB_ID" and ID length is 2-5), join on geography.sky_code. If encoding is "SS_GEO1_ID" or "DDB_ID" and ID length is 1, 8, or 9, join on geography.entity_id. If the location_id is "1", "EVERYWHERE", "ANYWHERE", or "UNDEFINED", set entity_id to "1". Use the resulting geography.entity_id value
- **Purpose**: Standardized destination entity ID joinable to reference.geography table

#### destination_location_type
- **Type**: STRING
- **Nullable**: True
- **Source**: Derived via geography reference lookup
- **Business Logic**: After performing the geography lookup as described for destination_entity_id, use the geography.entity_type value. If the location is "EVERYWHERE", set to "EVERYWHERE"
- **Purpose**: Type of destination location (e.g., CITY, AIRPORT, ISLAND, EVERYWHERE)

#### destination_location_name
- **Type**: STRING
- **Nullable**: True
- **Source**: Derived via geography reference lookup
- **Business Logic**: After performing the geography lookup as described for destination_entity_id, use the geography.entity_reporting_name value. If the location is "EVERYWHERE", set to "EVERYWHERE"
- **Purpose**: Human-readable name of the destination location

### Search Classification

#### is_defined_search
- **Type**: BOOLEAN
- **Nullable**: True
- **Source**: Calculated
- **Business Logic**: Determine if the search is defined (specific) or exploratory. A search is defined (TRUE) if ALL of the following conditions are met: 1) The vertical is "FLIGHT" or "COMBINED_SEARCH", 2) The departure_timestamp_precision is "DAY" or "MINUTE", 3) The arrival_timestamp_precision (or departure_timestamp_precision if arrival is null) is "DAY" or "MINUTE", 4) The origin_location_type is "CITY", "AIRPORT", or "ISLAND", 5) The destination_location_type is "CITY", "AIRPORT", or "ISLAND". If any condition is not met, set to FALSE. If vertical is not FLIGHT or COMBINED_SEARCH, set to NULL
- **Purpose**: Flag indicating if this is a defined/live search (TRUE) or an exploratory search (FALSE)

#### vertical
- **Type**: STRING
- **Nullable**: True
- **Source**: Direct mapping from `business_domain`
- **Business Logic**: Extract the business_domain field which indicates the vertical (FLIGHT, COMBINED_SEARCH)
- **Purpose**: Indicates the business vertical (FLIGHT for standalone flight searches, COMBINED_SEARCH for combined searches)

### Platform Attributes

#### platform
- **Type**: STRING
- **Nullable**: False
- **Source**: Derived from source table name
- **Business Logic**: Determine the platform based on the source table: android_mini_search → "APP", ios_mini_search → "APP", frontend_mini_search → "WEBSITE", banana_mini_search → "WEBSITE", acorn_funnel_events_search → "WEBSITE", server_mini_search → "WEBSITE"
- **Purpose**: High-level platform classification (APP or WEBSITE)

#### platform_subtype
- **Type**: STRING
- **Nullable**: False
- **Source**: Derived from source table name
- **Business Logic**: Determine the platform subtype based on the source table: android_mini_search → "ANDROID_APP", ios_mini_search → "IOS_APP", frontend_mini_search → "FRONTEND_WEB", banana_mini_search → "BANANA_WEB", acorn_funnel_events_search → "ACORN_WEB", server_mini_search → "SOL_WEB"
- **Purpose**: Detailed platform classification with specific application/site identification

### User Context

#### user_agent
- **Type**: STRING
- **Nullable**: True
- **Source**: Direct mapping from `header.user_agent`
- **Business Logic**: Extract user_agent string from event header. Clean the string by removing leading/trailing whitespace and converting empty strings to NULL
- **Purpose**: User agent string for browser/device identification

#### producer_app_name
- **Type**: STRING
- **Nullable**: True
- **Source**: Direct mapping from `header.producer_name`
- **Business Logic**: Extract producer_name from event header. Clean the string by removing leading/trailing whitespace and converting empty strings to NULL
- **Purpose**: Name of the application that produced the event

#### producer_app_version
- **Type**: STRING
- **Nullable**: True
- **Source**: Direct mapping from `header.producer_version`
- **Business Logic**: Extract producer_version from event header. Clean the string by removing leading/trailing whitespace and converting empty strings to NULL
- **Purpose**: Version of the application that produced the event

#### ip_address
- **Type**: STRING
- **Nullable**: True
- **Source**: Direct mapping from `header.client_ip`
- **Business Logic**: Extract client_ip from event header. Clean the string by removing leading/trailing whitespace and converting empty strings to NULL
- **Purpose**: Client IP address for geo-location and fraud detection

#### ip_country_name
- **Type**: STRING
- **Nullable**: True
- **Source**: Direct mapping from `country_name`
- **Business Logic**: Extract country_name derived from IP address. Clean the string by removing leading/trailing whitespace and converting empty strings to NULL
- **Purpose**: Country derived from IP address

#### ip_city_name
- **Type**: STRING
- **Nullable**: True
- **Source**: Direct mapping from `city_name`
- **Business Logic**: Extract city_name derived from IP address. Clean the string by removing leading/trailing whitespace and converting empty strings to NULL
- **Purpose**: City derived from IP address

#### traveller_preferred_country_code
- **Type**: STRING
- **Nullable**: True
- **Source**: Direct mapping from `header.user_context.country`
- **Business Logic**: Extract country preference from user_context in header. Clean the string by removing leading/trailing whitespace and converting empty strings to NULL
- **Purpose**: Traveler's preferred country code for localization

#### traveller_preferred_currency_code
- **Type**: STRING
- **Nullable**: True
- **Source**: Direct mapping from `header.user_context.currency`
- **Business Logic**: Extract currency preference from user_context in header. Clean the string by removing leading/trailing whitespace and converting empty strings to NULL
- **Purpose**: Traveler's preferred currency code for pricing display

#### traveller_preferred_locale
- **Type**: STRING
- **Nullable**: True
- **Source**: Direct mapping from `header.user_context.locale`
- **Business Logic**: Extract locale preference from user_context in header. Clean the string by removing leading/trailing whitespace and converting empty strings to NULL
- **Purpose**: Traveler's preferred locale for language/region preferences

#### sequence_number
- **Type**: INTEGER
- **Nullable**: True
- **Source**: Direct mapping from `header.sequence_number`
- **Business Logic**: Extract sequence_number from event header
- **Purpose**: Event sequence number for ordering events within a session

### Operational Metadata

#### dt
- **Type**: DATE
- **Nullable**: False
- **Source**: Partition key from source tables
- **Business Logic**: Extract the dt (date) partition key from the source table
- **Purpose**: Date partition key for data organization and query optimization

#### is_internal_user
- **Type**: BOOLEAN
- **Nullable**: True
- **Source**: Calculated from ip_address
- **Business Logic**: Determine if the user is internal based on IP address matching internal IP ranges
- **Purpose**: Flag to identify and filter internal/employee traffic

---

## Data Quality Rules

### Completeness Checks
1. **Primary Key**: `search_request_id` must not be null
2. **Natural Key Components**: At least one of (`request_id`, `guid`, `utid`) must not be null
3. **Partition Key**: `dt` must not be null
4. **Platform Fields**: `platform` and `platform_subtype` must not be null

### Consistency Checks
1. **Trip Type Consistency**: If `trip_type` is "ONE_WAY", then `one_way_trip` must not be null and `return_trip`, `multi_city_trip` must be null
2. **Trip Type Consistency**: If `trip_type` is "RETURN", then `return_trip` must not be null and `one_way_trip`, `multi_city_trip` must be null
3. **Trip Type Consistency**: If `trip_type` is "MULTI_CITY", then `multi_city_trip` must not be null and `one_way_trip`, `return_trip` must be null
4. **Leg Count Consistency**: `number_of_legs` must match the trip type (1 for ONE_WAY, 2 for RETURN, array size for MULTI_CITY)
5. **Date Consistency**: For RETURN trips, `arrival_date` should be greater than or equal to `departure_date`
6. **Duration Consistency**: `trip_duration_days` should be non-negative
7. **Passenger Count**: Sum of `adult_passenger_count`, `child_passenger_count`, and `infant_passenger_count` should be greater than 0

### Validity Checks
1. **Timestamp Range**: All timestamps should be within reasonable ranges (not in distant past or future)
2. **Date Precision**: `departure_timestamp_precision` and `arrival_timestamp_precision` must be one of: DAY, MONTH, ANYTIME, MINUTE
3. **Trip Type Values**: `trip_type` must be one of: ONE_WAY, RETURN, MULTI_CITY
4. **Platform Values**: `platform` must be one of: APP, WEBSITE
5. **Vertical Values**: `vertical` must be one of: FLIGHT, COMBINED_SEARCH
6. **Passenger Counts**: All passenger counts must be non-negative integers
7. **Foreign Key Validity**: All foreign key values must exist in their reference tables

### Deduplication
- **Strategy**: Latest record wins based on `logged_event_utc_timestamp`
- **Deduplication Key**: `search_request_id` (derived from request_id + guid + utid + dt)
- **Note**: While `request_id + dt` could be used for deduplication at the request level, the full composite key ensures unique events per user

---

## Transformation Logic Summary

### High-Level Process Flow

1. **Source Data Extraction**
   - Read from all 6 bronze event sources (android, ios, frontend, banana, acorn, server)
   - Filter by date partition (`dt`) and business_domain (FLIGHT or COMBINED_SEARCH)
   - Separate queries for ONE_WAY, RETURN, and MULTI_CITY trips
   - Union all sources together

2. **Platform Classification**
   - Derive `platform` and `platform_subtype` based on source table name
   - Map to APP (Android/iOS) or WEBSITE (Frontend/Banana/Acorn/Server)

3. **Header and Common Field Extraction**
   - Extract user identifiers (utid, guid)
   - Extract header fields (user_agent, timestamps, IP info, user context)
   - Clean string fields (trim whitespace, nullify empty strings)

4. **Vertical-Specific Attribute Extraction**
   - Conditionally extract flight_search attributes (handles both FLIGHT and COMBINED_SEARCH verticals)
   - Extract cabin_class, search_kind, trip filters (baggage, nearby airports, direct only)

5. **Trip Type and Structure**
   - Determine trip_type (ONE_WAY, RETURN, MULTI_CITY)
   - Extract appropriate trip structure (one_way_trip, return_trip, multi_city_trip)
   - Calculate number_of_legs

6. **Passenger Information**
   - Extract passenger_group structure
   - Derive adult, child, and infant counts

7. **Geography Enrichment**
   - For Origin: Extract location_id and encoding, perform smart lookup against geography reference
   - For Destination: Extract location_id and encoding, perform smart lookup against geography reference
   - Handle "EVERYWHERE" searches specially (entity_id = "1")
   - Derive entity_id, location_type, and location_name for both origin and destination

8. **Date and Time Processing**
   - Convert Unix millisecond timestamps to timestamp data types
   - Normalize timestamp precision values
   - Extract date components from timestamps
   - Calculate trip_duration_days

9. **Search Classification**
   - Determine if search is defined vs exploratory based on date precision and location specificity

10. **Metadata and Operational Fields**
    - Add md_last_modified_utc_timestamp
    - Calculate is_internal_user flag
    - Generate search_request_id hash

11. **Final Schema Alignment**
    - Select columns in schema order
    - Ensure all required fields are present
    - Drop temporary intermediate columns

---

## Important Business Rules and Notes

### Adult Definition Change
As of 2025-09-16, the definition of "Adult" was changed to age 18+ to align with Skyscanner Global Definition. This change removed reliance on the non_adult_ages field which was not populated consistently across platforms (banana and iOS).

### Legacy Data Source
The `server_mini_search` source is marked as LEGACY and should only be used for historical analysis. New searches should come from the other 5 sources.

### Everywhere Searches
When users search for "Everywhere" destinations:
- `destination_entity_id` is set to "1"
- `destination_location_type` is set to "EVERYWHERE"
- `destination_location_name` is set to "EVERYWHERE"
- These searches are always classified as exploratory (is_defined_search = FALSE)

### Geography Lookup Logic
The geography lookup uses a smart matching algorithm:
- IATA codes are matched on sky_code
- Short IDs (2-5 chars) from SS_GEO1_ID or DDB_ID are matched on sky_code
- Longer IDs (1, 8, or 9 chars) from SS_GEO1_ID or DDB_ID are matched on entity_id
- This handles various location encoding schemes used across different platforms

### Combined Searches
The COMBINED_SEARCH vertical represents searches that include multiple travel products (e.g., flight + hotel). The flight_search attributes are nested under `combined_search.flight_search` path for these records.

### Timestamp Issues
There have been historical timestamp issues with banana_mini_search_results_option that are documented in the Slack discussion. These should be monitored.

---

## Change Log

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0.0 | 2025-10-26 | Meta Business Domain Team | Initial specification |

---

## Dependencies

### Upstream Dependencies
- All bronze event sources must be available for the target date partition
- Geography reference table must be up-to-date with latest location mappings

### Downstream Consumers
- Search analytics dashboards
- Conversion funnel analysis
- Search intent modeling
- Personalization and recommendation systems
- Business reporting

---

## Data Lineage

```
Bronze Sources → Silver Transformation → Flight Search Request Silver Table
├── android_mini_search ──┐
├── ios_mini_search ───────┤
├── frontend_mini_search ──┤
├── banana_mini_search ────┼──→ Transformation Logic ──→ flight_search_request
├── acorn_funnel_events ───┤         ↑
└── server_mini_search ────┘         │
                                     │
Reference Tables ────────────────────┘
├── geography
├── user_agent
└── currency_conversion
```

---

## Contact Information

- **Team**: Meta Business Domain Team
- **Slack Channel**: #meta-business-domain
- **Documentation**: [Internal Wiki Link]
- **Support**: meta-business-domain@company.com

---

## Appendices

### A. Sample Queries

#### Get defined searches for a specific date
```sql
SELECT *
FROM dev_trusted_lab.meta_business_domain_silver.flight_search_request1
WHERE dt = '2025-10-01'
  AND is_defined_search = TRUE
```

#### Analyze search patterns by platform
```sql
SELECT
  platform,
  platform_subtype,
  COUNT(*) as search_count,
  SUM(CASE WHEN is_defined_search THEN 1 ELSE 0 END) as defined_search_count
FROM dev_trusted_lab.meta_business_domain_silver.flight_search_request1
WHERE dt = '2025-10-01'
GROUP BY platform, platform_subtype
```

#### Popular routes
```sql
SELECT
  origin_location_name,
  destination_location_name,
  COUNT(*) as search_count
FROM dev_trusted_lab.meta_business_domain_silver.flight_search_request1
WHERE dt = '2025-10-01'
  AND is_defined_search = TRUE
GROUP BY origin_location_name, destination_location_name
ORDER BY search_count DESC
LIMIT 10
```

### B. Related Documentation
- [Open Data Contract Standard](https://bitol-io.github.io/open-data-contract-standard/latest/)
- Flight Search Request Notebook: `2.1_flight_search_request.ipynb`
- Skyscanner Adult Definition: [Confluence Page](https://skyscanner.atlassian.net/wiki/spaces/VIS/pages/1423705170/)