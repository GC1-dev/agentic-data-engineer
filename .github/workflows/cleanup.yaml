name: Cleanup
on:
  push:
    branches:
      - clean_up_dab

permissions:
  contents: read
  id-token: write
  pull-requests: write
  actions: read

jobs:
  CleanupDAB:
    name: Cleanup Active Deployment
    uses: skyscanner/reusable-workflows/.github/workflows/databricks-asset-bundles.yaml@v3
    secrets: inherit
    with:
      runs-on: ubuntu-latest-small
      databricks-runtime-version: 16.4
      service-principal-application-id: bcfc93d0-4c4a-460c-851f-4eb6e5fcec01
      databricks-workspace: dev
      delete-dab: true
      dry-run: false

  CleanupDABAllVersions:
    name: Cleanup All Bundle Versions
    uses: skyscanner/reusable-workflows/.github/workflows/databricks-asset-bundles.yaml@v3
    secrets: inherit
    needs: CleanupDAB
    if: always()
    with:
      runs-on: ubuntu-latest-small
      databricks-runtime-version: 16.4
      service-principal-application-id: bcfc93d0-4c4a-460c-851f-4eb6e5fcec01
      databricks-workspace: dev
      delete-dab: true
      dry-run: false

      # Delete all .bundle directories and all versions
      install-commands: |
        echo "Listing all bundle directories..."
        databricks workspace list /Workspace/Users/bcfc93d0-4c4a-460c-851f-4eb6e5fcec01/.bundle || echo "No .bundle directory found"

        echo "Deleting all bundle directories recursively..."
        databricks workspace delete --recursive /Workspace/Users/bcfc93d0-4c4a-460c-851f-4eb6e5fcec01/.bundle 2>/dev/null || true

        echo "Checking for remaining subdirectories..."
        for dir in $(databricks workspace list /Workspace/Users/bcfc93d0-4c4a-460c-851f-4eb6e5fcec01/.bundle 2>/dev/null | awk '{print $2}' || echo ""); do
          if [ -n "$dir" ]; then
            echo "Deleting $dir..."
            databricks workspace delete --recursive "/Workspace/Users/bcfc93d0-4c4a-460c-851f-4eb6e5fcec01/.bundle/$dir" || echo "Failed to delete $dir"
          fi
        done

        echo "âœ“ All bundle versions cleaned up"